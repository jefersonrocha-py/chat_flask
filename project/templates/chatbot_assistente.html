{% extends "base.html" %}
{% block content %}
<div class="chatgpt-container">
  <!-- SIDEBAR -->
  <aside class="chatgpt-sidebar" id="sidebar">
    <div class="sidebar-header">
      <!-- TOP: Botão Hamburger + Avatar/Username -->
      <div class="sidebar-top">
        <button class="toggle-sidebar-btn" onclick="toggleSidebar()">
          <!-- Ícone de 'hamburger' -->
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <path fill="currentColor" d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z" />
          </svg>
        </button>
        <div class="sidebar-user">
          <!-- Exibe a primeira letra do username em maiúsculo -->
          <div class="user-avatar">{{ session['full_name'][0] | upper }}</div>
          <span class="username">{{ session['full_name'] }}</span>
        </div>
      </div>
      <!-- Botão Novo Chat -->
      <button class="new-chat-btn" onclick="startNewChat()">+ Novo Chat</button>
    </div>
    <!-- Histórico de Conversas -->
    <nav class="sidebar-history">
      <ul id="history-list">
        <!-- Fica vazio inicialmente; preenchido ao conversar -->
      </ul>
    </nav>
    <div class="sidebar-footer">
      <button class="back-btn" onclick="goBack()">Voltar</button>
    </div>
  </aside>
  <!-- ÁREA PRINCIPAL DO CHAT -->
  <main class="chatgpt-main" id="mainContent">
    <header class="chatgpt-header">
      <h1>
        <!-- Ícone de IA com efeito hover -->
        <span class="title-icon">
          <svg width="24" height="24" viewBox="0 0 24 24">
            <path fill="currentColor"
              d="M9 21h6v-2H9v2zM12 2a7 7 0 0 0-7 7c0 2.31 1.16 4.35 2.91 5.57l.59.43v1c0 .28.11.53.29.71L9 18v1h6v-1l.21-.29c.18-.18.29-.43.29-.71v-1l.59-.43A7.001 7.001 0 0 0 19 9a7 7 0 0 0-7-7z">
            </path>
          </svg>
        </span>
        FlowMind AI RAG
      </h1>
    </header>
    <!-- Área de Mensagens -->
    <section id="messages" class="chatgpt-messages"></section>
    <!-- Formulário de Entrada -->
    <form id="chat-form" class="chatgpt-input-area">
      <input 
        type="text"
        id="user-input"
        placeholder="Digite sua mensagem..."
        autocomplete="off"
        required
      />
      <button type="submit" class="send-btn">Enviar</button>
    </form>
  </main>
</div>
{% endblock %}
{% block scripts %}
<script>
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  sidebar.classList.toggle('collapsed');
}

function startNewChat() {
  // Limpa o histórico de conversas e mensagens
  document.getElementById('messages').innerHTML = '';
  document.getElementById('history-list').innerHTML = '';
  alert('Novo chat iniciado!');
}

function goBack() {
  // Redireciona para a página de seleção de modo
  window.location.href = "{{ url_for('mode_selection') }}";
}

// Envio do formulário e exibição das mensagens
document.getElementById('chat-form').addEventListener('submit', function (e) {
  e.preventDefault();
  const userInput = document.getElementById('user-input').value.trim();
  if (!userInput) return;

  // Envia mensagem ao servidor
  fetch('/chatbot_assistente', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `user_input=${encodeURIComponent(userInput)}`
  })
  .then(response => response.json())
  .then(data => {
    // Exibe a mensagem do usuário
    const messagesDiv = document.getElementById('messages');
    messagesDiv.innerHTML += `<p><strong>Você:</strong> ${userInput}</p>`;
    // Exibe a resposta do assistente
    messagesDiv.innerHTML += `<p><strong>Assistente:</strong> ${data.response || data.error}</p>`;
    // Adiciona um item ao histórico (usando parte do texto do usuário)
    const historyList = document.getElementById('history-list');
    const li = document.createElement('li');
    li.textContent = userInput.length > 20 ? userInput.substring(0, 20) + '...' : userInput;
    li.onclick = () => {
      // Ao clicar no histórico, recupera a conversa
      document.getElementById('messages').innerHTML = `<p><strong>Você:</strong> ${userInput}</p>`;
      document.getElementById('messages').innerHTML += `<p><strong>Assistente:</strong> ${data.response || data.error}</p>`;
    };
    historyList.appendChild(li);
    // Limpa o campo de input
    document.getElementById('user-input').value = '';
  });
});
</script>
{% endblock %}